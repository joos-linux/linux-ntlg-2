# linux-ntlg-2

### Дистрибутивы
**История Linux**
**Эндрю Танненбаум** (Andrew Tanenbaum, родился 16.03.1944 г.) – профессор Амстердамского свободного университета, известен как автор ОС Minix (свободная Unix- подобная операционная система для образовательных целей) и книг по компьютерным наукам («Компьютерные сети», «Современные операционные системы»).

**Ричард Столлман** (Richard Stallman, родился 16.03.1953 г.) – основатель движения свободного ПО, проекта GNU, Фонда свободных программ иЛиги за свободу программирования. В рамках проекта GNU программистами из разных стран разрабатывалось ПО, которое впоследствии вошло в GNU/Linux.

**Проект GNU** (GNU’s Not UNIX — «GNU — не Unix») – проект по разработке свободного программного обеспечения (СПО). Проект был запущен Ричардом Столлманом в 1983 году. GNU GPL – это лицензия, согласно которой автор передает ПО в общественную собственность. У проекта GNU есть собственное ядро – Hurd. В отличие от Linux имеет микроядерную архитектуру.

**Линус Торвальдс** (Linus Torvalds, родился 28.12.1969 г.) — финно-американский программист. Известен как автор и разработчик Linux – ядра операционной системы GNU/Linux, являющейся на данный момент самой распространённой из свободных операционных систем, а также наиболее популярной серверной.

**Дистрибутив** – это форма распространения системного программного обеспечения.
Дистрибутив обычно содержит программы для начальной инициализации системы (инициализация аппаратной части, загрузка урезанной версии системы и запуск программы-установщика), программу-установщик (для выбора режимов и параметров установки) и набор специальных файлов, содержащих отдельные части системы (пакеты, сюда входит ядро, прикладные приложения и т.д.). Программа установки позволяет установить и произвести первичную настройку системы.

**Из чего состоит дистрибутив?**
- ядро;
- система инициализации;
- предустановленный и доступный набор ПО;
- графическая оболочка по умолчанию;
- пакетный менеджер;
- исправления и другое ПО от разработчиков дистрибутива.

**Дистрибутивы для серверов предприятий**
- Данные дистрибутивы обладают высокой надежностью и стабильностью. За счет этого чаще всего встречаются на промышленных серверах.
- RHEL, CentOS – коммерческая и свободная версия дистрибутива от Red Hat;
- Ubuntu (Server / Desktop) – серверная и десктопная версии от компании Canonical. Возможна коммерческая поддержка;
- SUSE Linux Enterprise (Server / Desktop) – cерверная и десктопная версия от компании SUSE. Возможна коммерческая поддержка;
- Oracle Linux – версия Linux от компании Oracle. Основана на Red Hat. Возможна коммерческая поддержка.


### Управление пакетами
**Репозиторий** — хранилище данных, в данном случае — пакетов ПО.

**Менеджер пакетов** – специальное программное обеспечение, которое управляет загрузкой, установкой, удалением пакетов, а также решением зависимостей. Наиболее популярными менеджерами пакетов являются APT (семейство Debian) и YUM (семейство Red Hat)

**Пакет** – это архив специального формата, который содержит:
- все необходимые приложению бинарные и конфигурационные файлы;
- информацию о том, как их следует разместить в файловой системе;
- данные о зависимостях пакета;
- список действий, которые необходимо выполнить в процессе установки.

**Зависимости** - Практически любая достаточно объемная программа требует для своей работы дополнительные библиотеки и компоненты. Такие дополнительные материалы, необходимые для работы приложения, устанавливаемого из пакетов, называют зависимостями. Современные пакетные менеджеры решают эту проблему благодаря описанию зависимостей в пакете

**Сторонние репозитории** - Иногда крупные разработчики программного обеспечения (яркий пример – PHP) не хотят выкладывать свои приложения в базовые репозитории того или иного дистрибутива, а вместо этого организовывают свои собственные репозитории, в которых хранят пакеты, доступные для установки на разные дистрибутивы Linux. Такие репозитории называют сторонними.

**Подключение сторонних репозиториев** - Для того чтобы иметь возможность устанавливать ПО из сторонних репозиториев, их надо указать в source.list вашего пакетного менеджера и скачать gpg-ключ для него.

**Компиляция пакета из исходников** - В современном мире не всегда приложение упаковывается в готовый пакет. Самые последние версии ПО, к примеру, зачастую распространяются в форме исходного кода.

**Команда make** - Для сборки нам нужны компиляторы: они прописаны в зависимостях пакета build-essential, так что достаточно установить его со всеми зависимостями. Ещё нужны autoconf и automake. Убедитесь в наличии файла configure, необходимого для процесса сборки. Для его генерации надо выполнить: ./bootstrap или ./autogen.sh.
- **make** – сборка пакета, установка в нем нужных параметров и подготовка к установке.
- **make install** – устанавливает сконфигурированное приложение в систему.
- **checkinstall** – программа для сборки .deb-пакета дистрибутива Ubuntu. Использование этой программы не всегда работает по причине отсутствия описания в исходниках у некоторых программ.
- **dpkg-deb --build** – более надежный вариант создания пакета в дистрибутиве Debian.
- **rpmbuild** – программа для сборки .rpm-пакета.

Для создания пакета необходимо иметь готовый spec-файл (control для .deb), который описывает пакет, его зависимости, имя, описание и так далее.
Собранный пакет дальше устанавливается при помощи менеджера пакетов.

**Пример сборки пакета на Debian**
- Скачать исходные файлы приложения.
- Создать файл, описывающий пакет spec для .rpm, control для .deb.
- Выполнить dpkg-deb --build <source_dir> Удобнее всего это сделать, поднявшись на уровень выше в иерархии каталогов.
- Установить получившийся пакет при помощи пакетного менеджера.

**APT (advanced packaging tool)** — программа для установки, обновления и удаления программных пакетов в операционных системах Debian и основанных на них (Ubuntu, Linux Mint и т. п.).
Способна автоматически устанавливать и настраивать программы для UNIX-подобных операционных систем как из предварительно откомпилированных пакетов, так и из исходных кодов.

**YUM (Yellowdog Updater, Modified)** — открытый консольный менеджер пакетов для дистрибутивов Linux, основанных на пакетах формата RPM (RedHat, CentOS, Fedora, Oracle Linux).
Как и APT, менеджер YUM работает с репозиториями пакетов от производителя дистрибутива или от сторонних авторов, также способен автоматически устанавливать и настраивать программы.


### Инициализация системы. Init, Systemd
**init** — специальный процесс (демон) управления системой и службами. Расположение: /sbin/init

**Режимы работы init:**
- однопользовательский (службы не запускаются);
- многопользовательский (режим запуска по умолчанию);
- сервер (аналогичен многопользовательскому, но без GUI).

**Варианты init**
- System V: Все службы запускаются последовательно.
- BSD init: FreeBSD, NetBSD, OpenBSD.
- systemd: упрощенный процесс загрузки; параллельный запуск служб; запись событий в системный журнал.

**Процесс запуска Init-V**
- GRUB загружает и запускает ядро;
- ядро запускает /sbin/init;
- init разбирает /etc/inittab и выполняет сценарий для инициализации системы;
- init выполняет скрипт /etc/rc.d/rc или /etc/init.d/rc;
- скрипты из /etc/rcn.d или /etc/init.d/rcn.d запускают различные службы.

**Уровни запуска Init-V**
- остановка работы с выключением;
- (S) — однопользовательский режим;
- многопользовательский режим без выхода в сеть;
- многопользовательский режим с сетью, но без запуска X;
- обычно не применяется;
- многопользовательский режим с сетью и запуском X (по умолчанию);
- остановка работы компьютера с перезагрузкой.
- **who -r** - Определение уровня запуска

**Определение типа init**
- Systemd — если в системе есть каталоги /usr/lib/systemd и /etc/systemd;
- Upstart — если каталог /etc/init содержит несколько файлов с расширением .conf, можно выполнить команду initctl;
- System V init — если ни один из приведенных вариантов не подходит, однако есть файл /etc/inittab.
-  file /sbin/init

**Модуль (unit)** — описывает запускаемую службу, устройство и т.п.
Каждый модуль описан в своем файле (unit file):
- /usr/lib/systemd/system/ – модули из пакетов (Nginx, Apache, MySQL);
-  /run/systemd/system/ — модули, созданные во время работы ОС;
- /etc/systemd/system/ — модули, созданные пользователем.

**Типы модулей**
- модули служб — обычные службы ОС;
- модули монтирования — монтируют ФС;
- целевый модули/цели — группируют другие модули;

**Цель (target)** — нужное состояние системы; ссылка на файл, содержащий зависимости (службы).
- Systemd запускает все зависимости из соответствующего target- файла.
- Когда все зависимости будут запущены, то система будет работать на соответствующем target-уровне
- **man bootup** - Иерархия целей

**Модули служб**
systemctl --all -t service - Просмотр всех служб
systemctl status sshd.service - Просмотр выбранной службы (ssh)
cat /etc/systemd/system/multi-user.target.wants/ssh.service - Пример модуля

**Раздел Unit**
Description=OpenBSD Secure Shell server — описание службы
After=network.target auditd.service — запуск после (after) этой службы
ConditionPathExists=!/etc/ssh/sshd_not_to_be_run — условная зависимость
- systemctl list-units — список модулей;
- systemctl list-units --type=service — список модулей-служб;
- systemctl status <модуль> — состояние выбранного модуля;
- systemctl enable\disable <модуль> — разрешить/запретить модуль;
- systemctl start\stop\restart <модуль> — запустить/остановить/... модуль;
- systemctl daemon-reload — перезапуск конфигурации systemd.

**Шаблон** - специальный unit-файл, позволяющий systemd работать снесколькими экземплярами unit.
Для вызова шаблона использует специальный формат: <имя_службы>@<аргумент>.service
```
journalctl - Журнал — база данных, в которой хранятся сообщения ядра и служб, начиная с загрузки и заканчивая завершением работы.
journalctl -u=sshd — сообщения для модуля ssh
journalctl -b 0 -u ssh — ... только в текущем сеансе
journalctl --list-boots — загрузки
journalctl -n 100 /usr/sbin/sshd — показать внешний лог
journalctl --since=yesterday --until=now — временной период
```

### Управление пользователями
**root** (superuser, суперпользователь) – обязательный пользователь во всех Linux. Root может прочитать, удалить или изменить любой файл (следовательно и всё) в системе. Для root: UID = 0, GUID = 0, домашний каталог = /root

**sudo** – временное повышение прав текущего пользователя до root.

**/etc/sudoers** – список пользователей или групп, которым разрешено использовать sudo

id - показывает uid, guid, и все группы в которых пользователь
Значение UID:
- 1-99 – системные пользователи
- 100-999 – пользователи-службы
- 1000-4999 – пользователи-люди
- 5000-9999 – дополнительный пользователи и группы

**Домашний каталог** – место, где пользователь может хранить свои файлы. Все файлы созданные в этом каталоге будут доступны пользователю на чтение и запись.
- По умолчанию: /home/<имя пользователя>

**/etc/passwd** – файл, содержащий список пользователей системы

**/etc/shadow** – файл, содержащий список паролей пользователей

**/etc/group** – файл, содержащий список групп пользователей

**/etc/sudoers** - файл, содержащий список суперпользователей
- Для редактирования применяется команда visudo
- root ALL=(ALL:ALL) ALL – root может запускать любую команду в любой группе на любом хосте;
- %admin ALL=(ALL) ALL – аналогично для группы admin.
**/etc/login.defs** – файл, содержащий параметры входа по умолчанию.
**User**
**cat /etc/default/useradd** - файл для созданию пользователя - можно поменять домашнюю директорию, bash, или папку /etc/skell - для наполнения дом каталога по умолчанию
- useradd -D - отображает значения для пользователя по умлочанию
- sudo useradd xakep - создание пользователя
- su xakep - зайти под пользователем xaker - удобно с пользователями службами (без пароля)
- usermod --lock xakep - блокировка пользователя
- sudo passwd xakep - сменя пароля
- sudo userdel xakep - удаление
**Groups**
- groupadd ctf - создание группы
- groupmod -n ctf ftc - переименование группы
- sudo groupdel ftc - удаление группы

**/etc/security/limits.conf** – файл, содержащий ограничения ресурсов

**Права доступа**

**Атрибуты файла** - Права пользователя, Права группы, Права «всех других»

**Специальные биты**
- Setuid (suid) – позволяет пользователю выполнять программу с правами владельца (s в атрибутах файла).
- Setgid (sgid) – работает аналогично setuid, но для группы.
- Sticky – в таком каталоге пользователь может удалять только свои файлы (t в атрибутах файла).
Для большей безопасности при монтировании ФС можно указать параметр nosuid для отключения флагов suid и setgid.

**chmod (change mode)** – утилита для изменения прав доступа

**chown (change owner)** – утилита для изменения владельца файла

**chgrp (change group)** – утилита для изменения групп

**umask (user mask)** – задает биты доступа, устанавливаемые по умолчанию для всех новых файлов. Заметим, что бит Х никогда не устанавливается для созданных файлов. Umask обладает «инверсной» логикой, т.е. единицы в маске задают нули в правах доступа.

**Запуск приложений**
- Набираем команду и нажимаем «Enter».
- Оболочка (bash и т.д.) разбирает путь, параметры.
- Если введена внутренняя команда, то запускается её выполнение.
- Если введена внешняя команда / имя приложения вместе с путем, то запускается выполнение приложения.
- Если введена внешняя команда / имя приложения и путь не указан, то оболочка просматривает все каталоги в переменной $PATH. Если приложение найдено, оно запускается на выполнение

**Переменная $PATH (путь)** – список каталогов, разделенных символом «;»
- echo $PATH - Просмотр $PATH

**Основные переменные окружения**
- HOME=/home/user – домашний каталог пользователя;
- LOGNAME=user – имя пользователя в текущей оболочке;
- PWD=/home/user – текущий рабочий каталог;
- SHELL=/bin/bash – командная оболочка;
- LC_*=ru_RU.UTF-8 – переменные для локализации;
- LANG=en_US.UTF-8 – язык системы.

### Производительность системы
**Производительность системы** – количественные характеристики скорости выполнения определенных операций устройств и программ таких как:
- ядро операционной системы;
- процессы и программы;
- оперативная память;
- центральные процессоры;
- накопители информации.

**Ядро операционной системы**
- обрабатывает прерывания от устройств;
- выполняет запросы системных процессов и пользовательскихприложений;
- распределяет виртуальную память;
- создает и уничтожает процессы;
- обеспечивает многозадачность посредством переключениямежду ними;
- содержит драйверы устройств;
- обслуживает файловую систему.

**Процесс программы** в ядре представляется просто как структура с множеством полей:
- идентификатор процесса (pid);
- открытые файловые дескрипторы (fd);
- обработчики сигналов (signal handler);
- текущий рабочий каталог (cwd);
- переменные окружения (environ);
- код возврата.

**Оперативная память** - Влияет на производительность системы в целом, так как программы при запуске сохраняются в ней. Кроме этого если не присутствует нехватка оперативной памяти, то это приводит к постоянному кэшированию памяти на накопитель в раздел SWAP.

**Центральные процессоры**
Элемент системы который отвечает за обработку операций.
Характеристики влияющие на производительность:
- архитектура;
- кэш память процессора;
- скорость шины передачи данных;
- множитель частот;
- число потоков;
- число ядер процессора

**Накопители информации**
Компонент системы нужный для хранения информации;
- все программы как и операционная система, так и ядро загружается с накопителя;
- чем быстрее шина, чем быстрее чтения и запись данных, тем производительней система;
- на производительность также может влиять использование технологии RAID

**Утилиты мониторинга производительности**
- top – вывод список работающих в системе процессов и информацию о них;
- atop – продвинутый интерактивный полноэкранный мониторпроизводительности;
- mpstat – выводит статистику по процессору;
- iostat – мониторит использования дисковых разделов;
- pidstat – выводит статистику по процессам;
- vmstat – выводит статистику процессора, памяти и о процессах;
- lvm – инструмент для работы LVM;
- mdraid – программа для работы с массивами дисков.

**sysstat** – это набор инструментов мониторинга производительности для Linux

В состав пакета входят следующие утилиты:
- mpstat - отчет о использовании процессоров
- pidstat - используется для мониторинга процессов в режиме реального время
-  -t – выводит на экран информацию в виде дерева; Например: pidstat -t -C “mysql”.
- - -rud – посмотреть всю статистику в горизонтальном виде и на одной строке.
- vmstat - редоставляет краткую информацию о различных ресурсах системы и связанных с ними неполадках, приводящих к снижению производительности
- iostat - мониторинг использования дисковых разделов

### Производительность системы 2

Операционная система при своей работе сохраняет всю информацию работы устройств в директории **/proc**. Устройство в системе рассматривается как блочное устройство с системой ввода и вывода. Устройства, как правило, рассматриваются файлом через который можно считывать или куда можно записывать информацию. Находится данные файлы в директории **/dev**. Как видно из примера, некоторые файлы ссылаются на директорию **/proc**.

**Накопители информации** - Компонент системы нужный для хранения информации. Все программы: как и операционная система, так и ядро, – загружается с накопителя. Чем быстрее шина, чем быстрее чтения и запись данных тем производительней система. Кроме этого на производительность может влиять использование технологии RAID.

**RAID** (Redundant Array of Independent Disks, избыточный массив независимых дисков) — технология виртуализации данных, которая объединяет несколько дисков в логический элемент для повышения производительности и отказоустойчивости

**Методы для ускорения системы**
- **Cron** – планировщик заданий, используемый для планирования выполнения команд на определённое время.
- Работа с памятью компьютера (автомато чистить не нужные файлы)
- Работа с логами установок/обновлений (автоматом чистить логи и файлы обновлений)

**cpufreq** - В сборки различных систем входит пакет cpufreq, который отвечает за управлением питания процессора. Просмотреть значения частоты процессора: cat /proc/cpuinfo
Установочные ключи для работы демона:
- Ключ powersave – говорит энергосбережение
- Ключ performance – выставляет максимальное значение

**Ускорение swap** - Бывает так что оперативной памяти достаточно много, но по какой-то причине задействуется swap.
- Данные манипуляции ведут к уменьшению производительности.
- cat /proc/sys/vm/swappiness
- Позволяет увидеть распределение между оперативной памятью и swap.
- 
Исправить данную историю можно изменив параметры ядра:
- sudo sysctl vm.swappiness= x,
- x – значение, которое будет в процентом отношении выполнятся:
- - 0 – swap не будет использоваться;
- - 100 – оперативная память практически не будет использоваться.
Применим данные настройки в ядро системы: sudo sysctl -p

Утилиты мониторинга производительности
- iostat – мониторит использования дисковых разделов;
- vmstat – выводит статистику процессора, памяти и о процессах;
